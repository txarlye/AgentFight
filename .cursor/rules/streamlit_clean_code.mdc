---
description: Reglas de Clean Code para desarrollo Streamlit - Arquitectura, patrones y mejores prÃ¡cticas
globs: ["**/UI/Streamlit/**/*.py", "**/streamlit*.py", "**/.streamlit/**"]
alwaysApply: false
---

# ğŸ§¹ CLEAN CODE PARA STREAMLIT - iaBoletin

## ğŸ—ï¸ ARQUITECTURA Y ORGANIZACIÃ“N

### Estructura de Directorios
```
procesamiento/UI/
â”œâ”€â”€ console_ui.py            # UI de consola
â”œâ”€â”€ console_ui_rich.py       # UI de consola con Rich
â”œâ”€â”€ gradio_ui.py             # UI alternativa Gradio
â””â”€â”€ Streamlit/               # TODO lo relacionado con Streamlit
    â”œâ”€â”€ __init__.py
    â”œâ”€â”€ streamlit_ui.py      # Punto de entrada principal (movido aquÃ­)
    â”œâ”€â”€ .streamlit/          # ConfiguraciÃ³n de Streamlit
    â”‚   â””â”€â”€ config.toml      # ConfiguraciÃ³n del servidor
    â”œâ”€â”€ components/          # Componentes reutilizables
    â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”œâ”€â”€ navigation.py    # MenÃºs y barra lateral
    â”‚   â”œâ”€â”€ boletin_card.py  # Tarjetas de boletines
    â”‚   â””â”€â”€ data_table.py    # Tablas de datos
    â”œâ”€â”€ pages/               # PÃ¡ginas especÃ­ficas
    â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”œâ”€â”€ guardar_boa.py
    â”‚   â”œâ”€â”€ procesar_boa.py
    â”‚   â””â”€â”€ utilidades.py
    â”œâ”€â”€ utils/               # Utilidades UI
    â”‚   â”œâ”€â”€ __init__.py
    â”‚   â”œâ”€â”€ styling.py       # CSS y estilos
    â”‚   â”œâ”€â”€ helpers.py       # Funciones auxiliares
    â”‚   â””â”€â”€ logging.py       # Sistema de logging
    â””â”€â”€ [archivos existentes]
        â”œâ”€â”€ check_boa.py
        â”œâ”€â”€ gestor_patrones.py
        â”œâ”€â”€ boa_utils.py
        â””â”€â”€ config_check_boa.py
```

### Principios de OrganizaciÃ³n
- **SeparaciÃ³n de responsabilidades**: Cada archivo tiene una responsabilidad especÃ­fica
- **Componentes reutilizables**: Crear funciones modulares para UI
- **ConfiguraciÃ³n centralizada**: Usar settings singleton para configuraciÃ³n
- **PÃ¡ginas modulares**: Cada funcionalidad en su propio archivo
- **UI encapsulada**: Todo lo de Streamlit dentro de `procesamiento/UI/Streamlit/`
- **ConfiguraciÃ³n local**: `.streamlit/` dentro de la carpeta Streamlit

### GestiÃ³n de ConfiguraciÃ³n
```python
# âœ… CORRECTO - Usar settings singleton
from settings import settings

# Acceder a configuraciÃ³n
settings.OBJETOS_A_ENCONTRAR
settings.procesamiento_paralelo
settings.max_workers

# âŒ INCORRECTO - No duplicar con gestion_config.py
# gestion_config.py es redundante si ya tienes settings
```

### Configuraciones EspecÃ­ficas
```python
# âœ… CORRECTO - ConfiguraciÃ³n especÃ­fica para funcionalidades
# config_check_boa.py - Solo para Check BOA
class ConfigCheckBOA:
    BOA_URL = "https://www.boa.aragon.es/#/"
    RUTAS_ARCHIVOS = {...}

# âŒ INCORRECTO - No crear gestion_config.py genÃ©rico
# Ya tienes settings para eso
```

### OrganizaciÃ³n de Utils
```python
# utils/helpers.py - Funciones auxiliares generales
def formatear_fecha(fecha):
    """Formatea fecha para mostrar en UI"""
    return fecha.strftime("%d/%m/%Y")

def validar_entrada_usuario(entrada):
    """Valida entrada del usuario"""
    return entrada.strip() if entrada else None

# utils/styling.py - CSS y estilos
def aplicar_estilos_principales():
    """Aplica estilos CSS principales"""
    st.markdown("""<style>...</style>""", unsafe_allow_html=True)

def crear_tema_personalizado():
    """Crea tema personalizado para componentes"""

# utils/logging.py - Sistema de logging
def configurar_logging_streamlit():
    """Configura logging especÃ­fico para Streamlit"""
```

### OrganizaciÃ³n de Navigation
```python
# components/navigation.py - MenÃºs y navegaciÃ³n
def crear_sidebar_navegacion():
    """Crea barra lateral de navegaciÃ³n"""
    with st.sidebar:
        st.title("ğŸ  iaBoletin")
        # MenÃº de navegaciÃ³n
        
def crear_menu_principal():
    """Crea menÃº principal horizontal"""
    # Botones de navegaciÃ³n principal
    
def mostrar_breadcrumbs():
    """Muestra ruta de navegaciÃ³n actual"""
```

## ğŸ“ CONVENCIONES DE CÃ“DIGO

### Nomenclatura
```python
# âœ… CORRECTO
def mostrar_seccion_guardar_boa():
def procesar_con_logs(fecha, nlp, tipo_procesamiento):
def setup_page():

# âŒ INCORRECTO  
def show_boa():
def process_data():
def init():
```

### Estructura de Funciones
```python
def funcion_streamlit(parametros):
    """
    DescripciÃ³n clara de la funciÃ³n.
    
    Args:
        parametros: DescripciÃ³n de parÃ¡metros
        
    Returns:
        DescripciÃ³n del retorno
    """
    # 1. Validaciones iniciales
    if not parametros:
        st.error("Error: parÃ¡metros requeridos")
        return
    
    # 2. ConfiguraciÃ³n de estado
    if 'key' not in st.session_state:
        st.session_state['key'] = valor_default
    
    # 3. LÃ³gica principal
    try:
        resultado = procesar_datos(parametros)
        st.success("Procesamiento exitoso")
        return resultado
    except Exception as e:
        st.error(f"Error: {str(e)}")
        return None
```

## ğŸ¨ PATRONES DE UI

### GestiÃ³n de Estado
```python
# âœ… CORRECTO - InicializaciÃ³n segura
if 'seccion_activa' not in st.session_state:
    st.session_state['seccion_activa'] = 'Guardar BOA'

# âœ… CORRECTO - ActualizaciÃ³n de estado
if st.button("Nueva SecciÃ³n"):
    st.session_state['seccion_activa'] = 'Nueva SecciÃ³n'
    st.rerun()
```

### Manejo de Errores
```python
# âœ… CORRECTO - Manejo robusto
try:
    resultado = operacion_critica()
    st.success("OperaciÃ³n exitosa")
except FileNotFoundError:
    st.error("Archivo no encontrado")
except Exception as e:
    st.error(f"Error inesperado: {str(e)}")
    st.exception(e)  # Para debugging
```

### Caching Inteligente
```python
# âœ… CORRECTO - Cache para operaciones costosas
@st.cache_data(ttl=3600)  # 1 hora
def cargar_datos_boa(fecha):
    return procesar_archivos_boa(fecha)

# âœ… CORRECTO - Cache de recursos
@st.cache_resource
def cargar_modelo_nlp():
    return spacy.load("es_core_news_sm")
```

## ğŸ”§ COMPONENTES REUTILIZABLES

### Estructura de Componentes
```python
def crear_componente_boletin(titulo, datos, acciones):
    """
    Componente reutilizable para mostrar boletines.
    
    Args:
        titulo: TÃ­tulo del boletÃ­n
        datos: DataFrame con datos
        acciones: Lista de acciones disponibles
    """
    with st.container():
        st.subheader(titulo)
        
        # Mostrar datos
        if not datos.empty:
            st.dataframe(datos, use_container_width=True)
            
            # Botones de acciÃ³n
            col1, col2, col3 = st.columns(3)
            with col1:
                if st.button("Procesar", key=f"proc_{titulo}"):
                    procesar_boletin(datos)
            with col2:
                if st.button("Exportar", key=f"exp_{titulo}"):
                    exportar_datos(datos)
        else:
            st.info("No hay datos disponibles")
```

### CSS Personalizado
```python
def aplicar_estilos_personalizados():
    """Aplica estilos CSS personalizados de forma consistente."""
    st.markdown("""
    <style>
    .custom-header {
        font-size: 2rem;
        color: #1f77b4;
        text-align: center;
        margin-bottom: 1rem;
    }
    .success-box {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        border-radius: 0.375rem;
        padding: 1rem;
        margin: 1rem 0;
    }
    </style>
    """, unsafe_allow_html=True)
```

## âš¡ OPTIMIZACIÃ“N DE RENDIMIENTO

### Lazy Loading
```python
# âœ… CORRECTO - Carga condicional
def mostrar_seccion_pesada():
    if st.session_state.get('cargar_seccion_pesada', False):
        with st.spinner("Cargando datos..."):
            datos = cargar_datos_grandes()
            mostrar_resultados(datos)
    else:
        if st.button("Cargar secciÃ³n"):
            st.session_state['cargar_seccion_pesada'] = True
            st.rerun()
```

### GestiÃ³n de Memoria
```python
# âœ… CORRECTO - Limpieza de memoria
def limpiar_cache_antiguo():
    """Limpia cache antiguo para liberar memoria."""
    if 'cache_timestamp' in st.session_state:
        if time.time() - st.session_state['cache_timestamp'] > 3600:
            st.cache_data.clear()
            st.session_state['cache_timestamp'] = time.time()
```

## ğŸ§ª TESTING Y DEBUGGING

### Logging Estructurado
```python
import logging

def configurar_logging():
    """Configura logging para debugging."""
    logging.basicConfig(
        level=logging.INFO,
        format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
    )
    return logging.getLogger(__name__)

def debug_streamlit():
    """FunciÃ³n de debugging para Streamlit."""
    if st.checkbox("Modo Debug"):
        st.write("Session State:", st.session_state)
        st.write("Cache Info:", st.cache_data.get_stats())
```

## ğŸ”„ PLAN DE MIGRACIÃ“N

### Fase 1: ReorganizaciÃ³n de Estructura
```bash
# 1. Mover archivos existentes
mv procesamiento/UI/streamlit_ui.py procesamiento/UI/Streamlit/
mv .streamlit/ procesamiento/UI/Streamlit/

# 2. Crear nueva estructura
mkdir -p procesamiento/UI/Streamlit/components
mkdir -p procesamiento/UI/Streamlit/pages  
mkdir -p procesamiento/UI/Streamlit/utils

# 3. Actualizar imports en main.py
# Cambiar: from procesamiento.UI.streamlit_ui import StreamlitUI
# Por:     from procesamiento.UI.Streamlit.streamlit_ui import StreamlitUI
```

### Fase 2: ExtracciÃ³n de Componentes
```python
# Extraer de streamlit_ui.py (1935 lÃ­neas) a componentes:

# components/navigation.py
def crear_sidebar_navegacion():
    """Extraer lÃ³gica de navegaciÃ³n del archivo principal"""
    
# components/boletin_card.py  
def crear_tarjeta_boletin(datos):
    """Extraer lÃ³gica de tarjetas de boletines"""
    
# utils/styling.py
def aplicar_estilos_principales():
    """Extraer CSS del archivo principal"""
```

### Fase 3: SeparaciÃ³n de PÃ¡ginas
```python
# pages/guardar_boa.py
def mostrar_seccion_guardar_boa():
    """Extraer secciÃ³n de guardar BOA"""

# pages/procesar_boa.py  
def mostrar_seccion_procesar_boa(nlp):
    """Extraer secciÃ³n de procesar BOA"""
```

## ğŸš« ANTI-PATRONES A EVITAR

### âŒ INCORRECTO
```python
# Evitar: CÃ³digo monolÃ­tico
def main():
    st.title("App")
    # 500 lÃ­neas de cÃ³digo aquÃ­...
    
# Evitar: Variables globales
global_variable = "valor"

# Evitar: Sin manejo de errores
resultado = operacion_peligrosa()

# Evitar: Sin caching
def procesar_datos():
    return operacion_costosa()  # Se ejecuta cada vez
```

### âœ… CORRECTO
```python
# Modular y organizado
class StreamlitApp:
    def __init__(self):
        self.setup_page()
        self.configurar_logging()
    
    def setup_page(self):
        st.set_page_config(page_title="iaBoletin", layout="wide")
    
    def ejecutar(self):
        self.mostrar_navegacion()
        self.mostrar_contenido()

# ConfiguraciÃ³n centralizada
@st.cache_data
def cargar_configuracion():
    return settings.get_config()

# Manejo robusto de errores
try:
    resultado = operacion_peligrosa()
except Exception as e:
    st.error(f"Error: {e}")
    return None
```

## ğŸ“‹ CHECKLIST DE CALIDAD

### Antes de Commit
- [ ] Funciones con docstrings claros
- [ ] Manejo de errores implementado
- [ ] Caching aplicado donde corresponde
- [ ] Estado de sesiÃ³n manejado correctamente
- [ ] Componentes reutilizables
- [ ] CSS organizado y consistente
- [ ] Logging configurado
- [ ] Sin variables globales
- [ ] CÃ³digo modular y legible

### Patrones EspecÃ­ficos iaBoletin
- [ ] Usar `settings` singleton para configuraciÃ³n
- [ ] Integrar con `spaCy` para procesamiento NLP
- [ ] Mantener compatibilidad con BOA/BOE
- [ ] Preservar funcionalidad existente
- [ ] Usar `st.session_state` para estado persistente